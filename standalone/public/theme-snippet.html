<!-- 
  AI Visual Generator v2 - Theme-Based LLM Personalization
  ‰∏é embed.js ÂÆåÂÖ®ÂêåÊ≠•
-->
<script>
/**
 * AI Visual Generator v2 - Embed Script
 * 
 * ÂÆåÊï¥ÂäüËÉΩÁâàÊú¨Ôºå‰∏é theme-snippet.html ÂêåÊ≠•
 * 
 * Usage in Shopify theme.liquid:
 * <script src="https://shopify-ai-script-production.up.railway.app/embed.js" defer></script>
 */

(function () {
    'use strict';

    const CONFIG = {
        apiUrl: 'https://shopify-ai-script-production.up.railway.app/api',
        // Welcome Modal ÈÖçÁΩÆ
        showWelcomeModal: true,
        welcomeModalDelay: 500,
        // È¶ñÈ°µ‰∫ßÂìÅÂç°ÁâáÈÄâÊã©Âô®ÔºàÈÄÇÈÖçÂ∏∏ËßÅ‰∏ªÈ¢òÔºåÊ†πÊçÆÂÆûÈôÖ‰∏ªÈ¢òË∞ÉÊï¥Ôºâ
        productCardSelector: [
            '.product-card-wrapper',  // Dawn ‰∏ªÈ¢ò
            '.card-wrapper',          // Dawn ‰∏ªÈ¢òÂ§áÈÄâ
            '.card--standard',        // Dawn Âç°Áâá
            '.product-card',
            '.product-item',
            '.grid__item[class*="product"]',
            '.collection-product-card',
            '.card--product',
            'product-card',
        ].join(', '),
        // ‰∫ßÂìÅËØ¶ÊÉÖÈ°µÂ™í‰ΩìÂÆπÂô®ÈÄâÊã©Âô®
        productMediaContainerSelector: '.product__media-list, .product__media-wrapper, .product-media-container, .product__photos, .product-single__photos, .product__media-gallery, .product-gallery, media-gallery',
        // ‰∫ßÂìÅËØ¶ÊÉÖÈ°µÂçï‰∏™Â™í‰ΩìÈ°πÈÄâÊã©Âô®
        productMediaItemSelector: '.product__media-item, .product-media, .product__photo-wrapper, li[data-media-id], .media-gallery__item, .product__media-item--image',
        // Banner/Hero Image ÈÄâÊã©Âô®
        bannerSelector: '.banner__media img, .hero-banner img, .slideshow__image, .hero__image img, .image-hero img',
        // Collection Image ÈÄâÊã©Âô®
        collectionImageSelector: '.collection-card-wrapper img, .collection-list__item img, .collection-hero img, .collection__image img',
        // Image with Text ÈÄâÊã©Âô®
        imageWithTextSelector: '.image-with-text__media img, .image-with-text__media-item img, .image-with-text img',
        maxConcurrent: 8,  // ÊúÄÂ§ßÂπ∂ÂèëÁîüÊàêÊï∞ÔºàÂèØË∞ÉÊï¥Ôºö4-12Ôºâ
        timeout: 60000,
        debug: true,
        // ‰ΩøÁî® sessionStorage Ë∑®È°µÈù¢ÁºìÂ≠ò
        useSessionCache: true,
    };

    const log = (...args) => { if (CONFIG.debug) console.log('[AI Visual]', ...args); };

    // ÁîüÊàêÁä∂ÊÄÅÁÆ°ÁêÜÔºàÂÜÖÂ≠òÁºìÂ≠òÔºâ
    const generationState = new Map(); // key -> { status, imageUrl, targetImg }

    // =====================
    // UTM ÂèÇÊï∞ÊåÅ‰πÖÂåñÔºàË∑®È°µÈù¢‰øùÁïô UTMÔºâ
    // =====================

    const UTM_STORAGE_KEY = 'ai_visual_utm';
    const UTM_SESSION_KEY = 'ai_visual_utm_session'; // Ê†áËÆ∞ÂΩìÂâç‰ºöËØùÊòØÂê¶Êúâ UTM

    /**
     * Ê£ÄÊü•ÊòØÂê¶ÊòØÁ´ôÂÜÖË∑≥ËΩ¨Ôºàreferrer ÊòØÂêåÁ´ôÔºâ
     */
    function isInternalNavigation() {
        const referrer = document.referrer;
        if (!referrer) return false;
        try {
            const referrerHost = new URL(referrer).hostname;
            const currentHost = window.location.hostname;
            return referrerHost === currentHost;
        } catch {
            return false;
        }
    }

    /**
     * ‰ªé sessionStorage Ëé∑Âèñ UTM ÂèÇÊï∞
     */
    function getUtmFromSession() {
        try {
            const data = sessionStorage.getItem(UTM_STORAGE_KEY);
            if (!data) return null;
            return JSON.parse(data);
        } catch {
            return null;
        }
    }

    /**
     * Ê£ÄÊü•ÂΩìÂâç‰ºöËØùÊòØÂê¶Â∑≤ÁªèÊúâËøá UTMÔºàÁî®‰∫éÂà§Êñ≠Á´ôÂÜÖË∑≥ËΩ¨Êó∂ÊòØÂê¶Â∫îËØ•‰ΩøÁî®Â≠òÂÇ®ÁöÑ UTMÔºâ
     */
    function hasUtmSession() {
        return sessionStorage.getItem(UTM_SESSION_KEY) === 'true';
    }

    /**
     * ‰øùÂ≠ò UTM ÂèÇÊï∞Âà∞ sessionStorage
     * ÂÆåÂÖ®Ë¶ÜÁõñÔºöÈÉ®ÂàÜ UTM Êó∂ÔºåÊ≤°ÊúâÁöÑÂ≠óÊÆµÁïôÁ©∫
     */
    function saveUtmToSession() {
        const params = new URLSearchParams(window.location.search);
        const utmSource = params.get('utm_source');
        const utmMedium = params.get('utm_medium');
        const utmCampaign = params.get('utm_campaign');
        const utmContent = params.get('utm_content');
        const utmTerm = params.get('utm_term');

        log('üîç saveUtmToSession called:', {
            urlHasUtm: !!(utmSource || utmCampaign),
            utmSource,
            utmCampaign,
            isInternal: isInternalNavigation(),
            currentSession: sessionStorage.getItem(UTM_SESSION_KEY),
            currentUtm: sessionStorage.getItem(UTM_STORAGE_KEY)
        });

        // Âè™ÊúâÂΩì URL ‰∏≠Êúâ UTM ÂèÇÊï∞Êó∂Êâç‰øùÂ≠ò
        if (utmSource || utmCampaign) {
            // ÂÆåÂÖ®Ë¶ÜÁõñÔºåÊ≤°ÊúâÁöÑÂ≠óÊÆµÂ∞±ÊòØ null
            const utmData = {
                utmSource: utmSource || null,
                utmMedium: utmMedium || null,
                utmCampaign: utmCampaign || null,
                utmContent: utmContent || null,
                utmTerm: utmTerm || null,
            };
            try {
                sessionStorage.setItem(UTM_STORAGE_KEY, JSON.stringify(utmData));
                sessionStorage.setItem(UTM_SESSION_KEY, 'true'); // Ê†áËÆ∞Ê≠§‰ºöËØùÊúâ UTM
                log('üì¶ UTM saved to session:', utmData);
            } catch (e) {
                log('‚ùå UTM save error:', e);
            }
        } else if (!isInternalNavigation()) {
            // Â§ñÈÉ®ËøõÂÖ•‰∏îÊ≤°Êúâ UTM ‚Üí Ê∏ÖÈô§‰πãÂâçÁöÑ UTMÔºàÊñ∞ËÆøÈóÆÔºâ
            sessionStorage.removeItem(UTM_STORAGE_KEY);
            sessionStorage.removeItem(UTM_SESSION_KEY);
            log('üóëÔ∏è External visit without UTM, cleared session');
        } else {
            log('üìç Internal navigation without UTM, keeping session');
        }
    }

    // È°µÈù¢Âä†ËΩΩÊó∂Á´ãÂç≥Â§ÑÁêÜ UTM
    saveUtmToSession();

    // =====================
    // Landing Page ‰∏™ÊÄßÂåñ - ‰∫ßÂìÅÂÖÉÊï∞ÊçÆÈ¢ÑÂä†ËΩΩ
    // =====================

    let _productMetaPromise = null;
    let _productMetaCache = null;

    /**
     * È¢ÑÂä†ËΩΩ‰∫ßÂìÅÂÖÉÊï∞ÊçÆÔºàtags/title/handleÔºâ
     * Âú®ËÑöÊú¨Âä†ËΩΩÊó∂Á´ãÂç≥ÂèëËµ∑Ôºå‰∏çÁ≠â DOM
     * Âà∞ init() ÊâßË°åÊó∂Ôºà300ms ÂêéÔºâÊï∞ÊçÆÈÄöÂ∏∏Â∑≤Â∞±Áª™
     */
    function preloadProductMeta() {
        if (_productMetaPromise) return _productMetaPromise;

        _productMetaPromise = fetch(window.location.origin + '/products.json?limit=250')
            .then(function (res) { return res.ok ? res.json() : null; })
            .then(function (data) {
                if (!data || !data.products) return {};
                var meta = {};
                data.products.forEach(function (p) {
                    // Shopify products.json tags ÂèØËÉΩÊòØÊï∞ÁªÑ‰πüÂèØËÉΩÊòØÈÄóÂè∑ÂàÜÈöîÂ≠óÁ¨¶‰∏≤
                    var rawTags = p.tags;
                    var parsedTags;
                    if (Array.isArray(rawTags)) {
                        parsedTags = rawTags.map(function (t) { return String(t).toLowerCase().trim(); });
                    } else if (typeof rawTags === 'string' && rawTags.length > 0) {
                        parsedTags = rawTags.split(',').map(function (t) { return t.toLowerCase().trim(); }).filter(Boolean);
                    } else {
                        parsedTags = [];
                    }
                    meta[p.handle] = {
                        handle: p.handle,
                        title: (p.title || '').toLowerCase(),
                        tags: parsedTags,
                        type: (p.product_type || '').toLowerCase(),
                        price: p.variants && p.variants[0] ? parseFloat(p.variants[0].price) : 0,
                        available: p.variants ? p.variants.some(function (v) { return v.available; }) : false,
                    };
                });
                _productMetaCache = meta;
                log('[AI-LP] Product meta loaded:', Object.keys(meta).length, 'products');
                return meta;
            })
            .catch(function (err) {
                log('[AI-LP] Product meta fetch failed:', err && err.message ? err.message : err);
                return {};
            });

        return _productMetaPromise;
    }

    // Á´ãÂç≥ÂºÄÂßãÈ¢ÑÂä†ËΩΩÔºà‰∏çÁ≠â DOMÔºåÂ∞ΩÊó©ÂÆåÊàêÔºâ
    preloadProductMeta();

    // =====================
    // SessionStorage ÁºìÂ≠òÔºàË∑®È°µÈù¢ÊåÅ‰πÖÂåñÔºâ
    // =====================

    const CACHE_KEY = 'ai_visual_cache';
    const CACHE_TTL = 30 * 60 * 1000; // 30 ÂàÜÈíüËøáÊúü

    function getSessionCache() {
        if (!CONFIG.useSessionCache) return {};
        try {
            const data = sessionStorage.getItem(CACHE_KEY);
            if (!data) return {};
            const parsed = JSON.parse(data);
            // Ê∏ÖÁêÜËøáÊúüÁºìÂ≠ò
            const now = Date.now();
            Object.keys(parsed).forEach(key => {
                if (parsed[key].timestamp && now - parsed[key].timestamp > CACHE_TTL) {
                    delete parsed[key];
                }
            });
            return parsed;
        } catch {
            return {};
        }
    }

    function setSessionCache(key, imageUrl) {
        if (!CONFIG.useSessionCache) return;
        try {
            const cache = getSessionCache();
            cache[key] = { imageUrl, timestamp: Date.now() };
            sessionStorage.setItem(CACHE_KEY, JSON.stringify(cache));
        } catch (e) {
            log('Cache write error:', e);
        }
    }

    function getCachedUrl(key) {
        const cache = getSessionCache();
        return cache[key]?.imageUrl || null;
    }

    // ÁîüÊàêÂåÖÂê´ UTM ‰ø°ÊÅØÁöÑÁºìÂ≠ò Key
    function getUtmCacheKey(baseKey) {
        const utm = getUtmParams();
        const utmPart = [
            utm.utmSource || '',
            utm.utmCampaign || '',
            utm.utmContent || '',
            utm.utmTerm || '',
        ].filter(Boolean).join('_') || 'direct';
        return `${baseKey}__${utmPart}`;
    }

    // Ê≥®ÂÖ• CSS Âä®ÁîªÊ†∑Âºè
    const style = document.createElement('style');
    style.textContent = `
    @keyframes ai-shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    @keyframes ai-pulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }
    
    @keyframes ai-reveal {
        0% { clip-path: inset(0 100% 0 0); }
        100% { clip-path: inset(0 0 0 0); }
    }
    
    .ai-loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.03);
        overflow: hidden;
        pointer-events: none;
        z-index: 10;
    }
    
    /* ÁßªÈô§ÊñáÂ≠óÊèêÁ§∫ÔºåÂè™‰øùÁïô shimmer ÊïàÊûú */
    
    .ai-loading-overlay::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent 0%,
            rgba(255,255,255,0.4) 50%,
            transparent 100%
        );
        animation: ai-shimmer 1.5s ease-in-out infinite;
    }
    
    .ai-reveal {
        animation: ai-reveal 0.8s ease-out forwards;
    }
    
    .ai-generated-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 10px;
        padding: 4px 8px;
        border-radius: 12px;
        z-index: 5;
        pointer-events: none;
        opacity: 0.9;
    }
    
    /* ‰∫ßÂìÅÂç°ÁâáÁ¨¨‰∫åÂº†ÂõæÁöÑÂÆπÂô®Ê†∑Âºè */
    .ai-secondary-image-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .product-card:hover .ai-secondary-image-wrapper,
    .card--product:hover .ai-secondary-image-wrapper,
    [class*="product"]:hover .ai-secondary-image-wrapper {
        opacity: 1;
    }
    
    /* ===================== */
    /* Welcome Modal - Warm Theme */
    /* ===================== */
    
    @keyframes ai-modal-fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes ai-modal-slide-up {
        from { 
            opacity: 0;
            transform: translate(-50%, -48%);
        }
        to { 
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }
    
    @keyframes ai-paw-float {
        0%, 100% { transform: translateY(0) rotate(-5deg); }
        50% { transform: translateY(-8px) rotate(5deg); }
    }
    
    .ai-welcome-overlay {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(20, 15, 10, 0.7) !important;
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 999998 !important;
        animation: ai-modal-fade-in 0.25s ease-out forwards;
    }
    
    .ai-welcome-modal {
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 94%;
        max-width: 780px;
        max-height: 90vh;
        overflow-y: auto;
        background: linear-gradient(180deg, #FFFCF8 0%, #FFF9F2 100%);
        border-radius: 20px;
        padding: 36px 48px;
        z-index: 999999 !important;
        box-shadow: 0 25px 60px rgba(60, 40, 20, 0.3);
        animation: ai-modal-slide-up 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        color: #3D2E1F;
        text-align: center;
    }
    
    .ai-welcome-image {
        width: calc(100% + 96px);
        height: 160px;
        margin: -36px -48px 20px -48px;
        overflow: hidden;
    }
    
    .ai-welcome-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center 30%;
    }
    
    .ai-welcome-title {
        font-size: 26px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #2D2016;
        letter-spacing: -0.02em;
    }
    
    .ai-welcome-subtitle {
        font-size: 12px;
        color: #96640F;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 600;
        margin-bottom: 16px;
    }
    
    .ai-welcome-text {
        font-size: 15px;
        line-height: 1.7;
        color: #5C4A3A;
        margin-bottom: 20px;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    
    .ai-welcome-text strong {
        color: #96640F;
        font-weight: 600;
    }
    
    .ai-welcome-features {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }
    
    .ai-welcome-feature {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: #6B5344;
        background: rgba(150, 100, 15, 0.08);
        padding: 8px 14px;
        border-radius: 20px;
    }
    
    .ai-welcome-feature-icon {
        font-size: 16px;
    }
    
    .ai-welcome-close {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #96640F;
        color: #FFFFFF;
        border: none;
        padding: 14px 48px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .ai-welcome-close:hover {
        background: #7D5410;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(150, 100, 15, 0.35);
    }
    
    .ai-welcome-close:active {
        transform: translateY(0);
    }
    
    @media (max-width: 700px) {
        .ai-welcome-modal {
            padding: 28px 24px;
            max-width: 380px;
        }
        
        .ai-welcome-image {
            width: calc(100% + 48px);
            height: 120px;
            margin: -28px -24px 16px -24px;
        }
        
        .ai-welcome-title {
            font-size: 22px;
        }
        
        .ai-welcome-text {
            font-size: 14px;
        }
        
        .ai-welcome-features {
            gap: 10px;
        }
        
        .ai-welcome-feature {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .ai-welcome-close {
            padding: 12px 36px;
            font-size: 14px;
        }
    }
    
    /* ===================== */
    /* Landing Page ‰∏™ÊÄßÂåñ */
    /* ===================== */
    
    .ai-lp-hidden {
        display: none !important;
    }
    
    /* --- Grid 2-column --- */
    .ai-lp-grid-2col {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    @media (max-width: 749px) {
        .ai-lp-grid-2col {
            grid-template-columns: repeat(1, 1fr) !important;
        }
    }
    
    /* --- IWT flip (direction trick) --- */
    .ai-lp-iwt-flip .image-with-text,
    .ai-lp-iwt-flip .image-with-text__grid,
    .ai-lp-iwt-flip > .grid,
    .ai-lp-iwt-flip > div > .grid {
        direction: rtl;
    }
    .ai-lp-iwt-flip .image-with-text > *,
    .ai-lp-iwt-flip .image-with-text__grid > *,
    .ai-lp-iwt-flip > .grid > *,
    .ai-lp-iwt-flip > div > .grid > * {
        direction: ltr;
    }
    
    /* --- Card hover zoom --- */
    .ai-lp-hover-zoom .card__media img,
    .ai-lp-hover-zoom .card-wrapper img,
    .ai-lp-hover-zoom .card--standard img {
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
    }
    .ai-lp-hover-zoom .card__media:hover img,
    .ai-lp-hover-zoom .card-wrapper:hover img,
    .ai-lp-hover-zoom .card--standard:hover img {
        transform: scale(1.06) !important;
    }
    
    /* --- Rounded cards --- */
    .ai-lp-rounded .card__media,
    .ai-lp-rounded .card-wrapper .card,
    .ai-lp-rounded .card--standard {
        border-radius: 20px !important;
        overflow: hidden !important;
    }
    .ai-lp-rounded .card__media img {
        border-radius: 20px !important;
    }
    
    /* --- Compact hero (half height) --- */
    .ai-lp-hero-compact .banner,
    .ai-lp-hero-compact .slideshow,
    .ai-lp-hero-compact .hero {
        max-height: 320px !important;
        min-height: 200px !important;
        overflow: hidden !important;
    }
    @media (max-width: 749px) {
        .ai-lp-hero-compact .banner,
        .ai-lp-hero-compact .slideshow,
        .ai-lp-hero-compact .hero {
            max-height: 220px !important;
            min-height: 150px !important;
        }
    }
    
    /* --- Parallax hero --- */
    .ai-lp-parallax .banner__media img,
    .ai-lp-parallax .slideshow__image,
    .ai-lp-parallax .hero__image img {
        will-change: transform;
    }
    
    /* --- IWT overlap --- */
    .ai-lp-iwt-overlap .image-with-text__media-item,
    .ai-lp-iwt-overlap .image-with-text__media {
        margin-right: -30px !important;
        position: relative;
        z-index: 2;
    }
    .ai-lp-iwt-flip.ai-lp-iwt-overlap .image-with-text__media-item,
    .ai-lp-iwt-flip.ai-lp-iwt-overlap .image-with-text__media {
        margin-right: 0 !important;
        margin-left: -30px !important;
    }
    
    /* --- Extra spacing --- */
    .ai-lp-spacing .shopify-section {
        margin-bottom: 40px !important;
    }
    
    /* --- Featured hero card (first card spans 2 cols) --- */
    .ai-lp-featured-hero > li:first-child,
    .ai-lp-featured-hero > .grid__item:first-child {
        grid-column: span 2 !important;
    }
    .ai-lp-featured-hero > li:first-child .card__media,
    .ai-lp-featured-hero > .grid__item:first-child .card__media {
        min-height: 320px !important;
    }
    @media (max-width: 749px) {
        .ai-lp-featured-hero > li:first-child,
        .ai-lp-featured-hero > .grid__item:first-child {
            grid-column: span 1 !important;
        }
    }
    
    /* --- Sticky vibe bar --- */
    .ai-lp-vibe-bar.ai-lp-sticky {
        position: sticky;
        top: 0;
        z-index: 50;
    }
    
    /* --- Section dividers --- */
    .ai-lp-divider {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 16px;
        padding: 12px 0;
    }
    .ai-lp-divider::before,
    .ai-lp-divider::after {
        content: '';
        flex: 1;
        max-width: 120px;
        height: 1px;
        background: linear-gradient(90deg, transparent, #D4C5B0, transparent);
    }
    .ai-lp-divider svg {
        opacity: 0.4;
        color: #96640F;
    }
    
    /* --- Vibe Bar --- */
    .ai-lp-vibe-bar {
        width: 100%;
        padding: 14px 24px;
        background: linear-gradient(135deg, #FFF8F0 0%, #FFF3E6 50%, #FFF0DB 100%);
        border-bottom: 1px solid rgba(150, 100, 15, 0.12);
        text-align: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-sizing: border-box;
    }
    .ai-lp-vibe-bar__icon {
        display: flex;
        align-items: center;
    }
    .ai-lp-vibe-bar__icon svg {
        width: 20px;
        height: 20px;
        color: #96640F;
    }
    .ai-lp-vibe-bar__text {
        font-size: 15px;
        font-weight: 600;
        color: #5C3D0E;
        letter-spacing: 0.02em;
    }
    
    /* --- Trust Block --- */
    .ai-lp-trust-block {
        width: 100%;
        padding: 32px 24px;
        background: #FAFAF8;
        border-top: 1px solid #F0EDE8;
        border-bottom: 1px solid #F0EDE8;
        display: flex;
        justify-content: center;
        gap: 40px;
        flex-wrap: wrap;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-sizing: border-box;
    }
    .ai-lp-trust-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        min-width: 120px;
    }
    .ai-lp-trust-item__icon {
        display: flex;
        align-items: center;
    }
    .ai-lp-trust-item__icon svg {
        width: 28px;
        height: 28px;
        color: #96640F;
    }
    .ai-lp-trust-item__text {
        font-size: 13px;
        font-weight: 600;
        color: #5C4A3A;
        text-align: center;
    }
    
    @media (max-width: 749px) {
        .ai-lp-trust-block {
            gap: 24px;
            padding: 24px 16px;
        }
        .ai-lp-trust-item__icon svg { width: 24px; height: 24px; }
        .ai-lp-trust-item__text { font-size: 12px; }
        .ai-lp-vibe-bar__text { font-size: 13px; }
        .ai-lp-vibe-bar__icon svg { width: 18px; height: 18px; }
    }
`;
    document.head.appendChild(style);

    // =====================
    // Welcome Modal
    // =====================

    const MODAL_SHOWN_KEY = 'ai_visual_modal_shown';

    function shouldShowWelcomeModal() {
        if (!CONFIG.showWelcomeModal) return false;
        if (sessionStorage.getItem(MODAL_SHOWN_KEY)) return false;
        return true;
    }

    function showWelcomeModal() {
        if (!shouldShowWelcomeModal()) {
            log('Welcome modal already shown or disabled');
            return;
        }

        sessionStorage.setItem(MODAL_SHOWN_KEY, 'true');

        // Get traffic source for title
        const utm = getUtmParams();
        const sourceText = utm.utmSource
            ? utm.utmSource.charAt(0).toUpperCase() + utm.utmSource.slice(1)
            : null;

        const titleText = sourceText
            ? `Welcome from ${sourceText}!`
            : 'A Personalized Experience Awaits';

        const modalHTML = `
            <div class="ai-welcome-overlay" id="ai-welcome-overlay"></div>
            <div class="ai-welcome-modal" id="ai-welcome-modal">
                <div class="ai-welcome-image">
                    <img src="https://shopify-ai-script-production.up.railway.app/public/KWFfp1g77kxJMSnHD87aX_WNRvdBZc.png" alt="Happy pets">
                </div>
                <div class="ai-welcome-subtitle">Personalized Pet Experience</div>
                <h2 class="ai-welcome-title">${titleText}</h2>
                <p class="ai-welcome-text">
                    We're excited to show you something special! Our store uses <strong>AI-powered dynamic product imagery</strong> 
                    to create a unique shopping experience tailored just for you and your furry friends.
                    <br><br>
                    Every product photo you see is <strong>generated in real-time</strong>, matching current trends, 
                    seasonal vibes, and your browsing context. Images may take a few moments to appear ‚Äî 
                    it's worth the wait!
                </p>
                <div class="ai-welcome-features">
                    <div class="ai-welcome-feature">
                        <span class="ai-welcome-feature-icon">‚ú®</span>
                        <span>AI-Generated</span>
                    </div>
                    <div class="ai-welcome-feature">
                        <span class="ai-welcome-feature-icon">üéØ</span>
                        <span>Personalized</span>
                    </div>
                    <div class="ai-welcome-feature">
                        <span class="ai-welcome-feature-icon">üêæ</span>
                        <span>Pet-Focused</span>
                    </div>
                </div>
                <button class="ai-welcome-close" id="ai-welcome-close">
                    Start Shopping
                </button>
            </div>
        `;

        const container = document.createElement('div');
        container.id = 'ai-welcome-container';
        container.innerHTML = modalHTML;
        document.body.appendChild(container);

        const closeModal = () => {
            const overlay = document.getElementById('ai-welcome-overlay');
            const modal = document.getElementById('ai-welcome-modal');

            if (overlay) {
                overlay.style.transition = 'opacity 0.25s ease';
                overlay.style.opacity = '0';
            }
            if (modal) {
                modal.style.transition = 'all 0.25s ease';
                modal.style.opacity = '0';
                modal.style.transform = 'translate(-50%, -48%)';
            }

            setTimeout(() => container.remove(), 250);
            log('Welcome modal closed');
        };

        document.getElementById('ai-welcome-close')?.addEventListener('click', closeModal);
        document.getElementById('ai-welcome-overlay')?.addEventListener('click', closeModal);

        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                closeModal();
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);

        log('Welcome modal shown');
    }

    // =====================
    // Â∑•ÂÖ∑ÂáΩÊï∞
    // =====================

    function getUtmParams() {
        // ‰ºòÂÖà‰ªé URL ËØªÂèñ
        const params = new URLSearchParams(window.location.search);
        const urlUtmSource = params.get('utm_source');
        const urlUtmCampaign = params.get('utm_campaign');

        // Â¶ÇÊûú URL Êúâ UTM ÂèÇÊï∞Ôºå‰ΩøÁî® URL ÁöÑ
        if (urlUtmSource || urlUtmCampaign) {
            return {
                utmSource: urlUtmSource || undefined,
                utmMedium: params.get('utm_medium') || undefined,
                utmCampaign: urlUtmCampaign || undefined,
                utmContent: params.get('utm_content') || undefined,
                utmTerm: params.get('utm_term') || undefined,
            };
        }

        // Ë∞ÉËØïÔºöÊ£ÄÊü•Êù°‰ª∂
        const isInternal = isInternalNavigation();
        const hasSession = hasUtmSession();
        const savedUtm = getUtmFromSession();
        log('üîç UTM check:', { isInternal, hasSession, savedUtm, referrer: document.referrer });

        // Âè™Êúâ„ÄåÁ´ôÂÜÖË∑≥ËΩ¨ + Ê≠§‰ºöËØùÊúâËøá UTM„ÄçÊó∂Êâç‰ªé sessionStorage ËØªÂèñ
        if (isInternal && hasSession && savedUtm) {
            log('üìÇ Using UTM from session (internal navigation):', savedUtm);
            return {
                utmSource: savedUtm.utmSource || undefined,
                utmMedium: savedUtm.utmMedium || undefined,
                utmCampaign: savedUtm.utmCampaign || undefined,
                utmContent: savedUtm.utmContent || undefined,
                utmTerm: savedUtm.utmTerm || undefined,
            };
        }

        // Ê≤°Êúâ‰ªª‰Ωï UTM ÂèÇÊï∞
        return {
            utmSource: undefined,
            utmMedium: undefined,
            utmCampaign: undefined,
            utmContent: undefined,
            utmTerm: undefined,
        };
    }

    function getTimeContext() {
        const now = new Date();
        const hour = now.getHours();
        const month = now.getMonth();
        let timeOfDay = hour >= 5 && hour < 12 ? 'morning' : hour >= 12 && hour < 17 ? 'afternoon' : hour >= 17 && hour < 21 ? 'evening' : 'night';
        let season = month >= 2 && month <= 4 ? 'spring' : month >= 5 && month <= 7 ? 'summer' : month >= 8 && month <= 10 ? 'autumn' : 'winter';
        return { timeOfDay, season, clientTime: now.toISOString() };
    }

    function shouldProcess() {
        const utm = getUtmParams();
        const referrer = document.referrer || '';
        if (utm.utmSource || utm.utmCampaign) return true;
        return ['instagram', 'tiktok', 'facebook', 'google'].some(p => referrer.toLowerCase().includes(p));
    }

    function getProductHandleFromCard(card) {
        const link = card.querySelector('a[href*="/products/"]');
        if (!link) return null;
        const match = link.getAttribute('href')?.match(/\/products\/([^?#\/]+)/);
        return match ? match[1] : null;
    }

    function getProductHandleFromUrl() {
        const match = window.location.pathname.match(/\/products\/([^?#\/]+)/);
        return match ? match[1] : null;
    }

    function getCollectionInfo() {
        // ‰ªé URL Ëé∑Âèñ collection handle
        const urlMatch = window.location.pathname.match(/\/collections\/([^?#\/]+)/);
        const collectionHandle = urlMatch ? urlMatch[1] : null;

        // ‰ªé Shopify Analytics Ëé∑Âèñ
        const shopifyCollection = window.ShopifyAnalytics?.meta?.page?.pageType === 'collection'
            ? window.ShopifyAnalytics.meta.page
            : null;

        // ‰ªé DOM Ëé∑Âèñ collection Ê†áÈ¢ò
        const titleElement = document.querySelector('.collection-hero__title, .collection__title, h1.title, .page-header__title');
        const collectionTitle = titleElement?.textContent?.trim() || null;

        // ‰ªé DOM Ëé∑Âèñ collection ÊèèËø∞
        const descElement = document.querySelector('.collection-hero__description, .collection__description, .rte');
        const collectionDescription = descElement?.textContent?.trim()?.slice(0, 200) || null;

        // Ëé∑ÂèñÈ°µÈù¢‰∏äÁöÑ‰∫ßÂìÅÂêçÁß∞ÂàóË°®
        const productNames = [];
        const productCards = document.querySelectorAll('.product-card-wrapper, .card-wrapper, .product-card');
        productCards.forEach(card => {
            const nameEl = card.querySelector('.card__heading, .product-card__title, .card-information__text, h3 a');
            if (nameEl) {
                const name = nameEl.textContent?.trim();
                if (name && productNames.length < 5) {  // ÊúÄÂ§öÂèñ5‰∏™
                    productNames.push(name);
                }
            }
        });

        const info = {
            handle: collectionHandle,
            title: collectionTitle || collectionHandle?.replace(/-/g, ' '),
            description: collectionDescription,
            productNames: productNames,
            productCount: productCards.length,
        };

        log('Collection info:', info);
        return info;
    }

    // =====================
    // API ËØ∑Ê±Ç
    // =====================

    async function generateImage(imageUrl, imageType, productName = '') {
        return generateImageWithContext(imageUrl, imageType, { productName });
    }

    async function generateImageWithContext(imageUrl, imageType, extraContext = {}) {
        const context = {
            ...getUtmParams(),
            referrer: document.referrer,
            ...getTimeContext(),
            ...extraContext,
        };
        log('Generating:', { imageUrl, imageType, context });

        try {
            const response = await fetch(`${CONFIG.apiUrl}/generate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ imageUrl, imageType, ...context }),
            });
            const data = await response.json();
            log('Result:', data);
            return data.success ? data.imageUrl : null;
        } catch (error) {
            console.error('[AI Visual] Error:', error);
            return null;
        }
    }

    // =====================
    // È¶ñÈ°µ‰∫ßÂìÅÂç°ÁâáÂ§ÑÁêÜ
    // =====================

    function findProductCards() {
        // È¶ñÂÖàÂ∞ùËØïÈÖçÁΩÆÁöÑÈÄâÊã©Âô®
        let cards = document.querySelectorAll(CONFIG.productCardSelector);

        if (cards.length === 0) {
            // Â∞ùËØïÊõ¥Â§öÈÄöÁî®ÈÄâÊã©Âô®
            const fallbackSelectors = [
                // Dawn ‰∏ªÈ¢ò
                '.product-card-wrapper',
                '.card-wrapper',
                // ÂÖ∂‰ªñÂ∏∏ËßÅ‰∏ªÈ¢ò
                '.grid-product',
                '.product-grid-item',
                '.product-index',
                '.product-block',
                '.collection-product',
                // ÈÄöÁî®Ê®°ÂºèÔºöÂåÖÂê´‰∫ßÂìÅÈìæÊé•ÁöÑÂç°Áâá
                '[class*="product"][class*="card"]',
                '[class*="product"][class*="item"]',
                '.grid__item a[href*="/products/"]',
                // Êõ¥ÂÆΩÊùæÁöÑÂåπÈÖç
                'a[href*="/products/"]',
            ];

            for (const selector of fallbackSelectors) {
                try {
                    const found = document.querySelectorAll(selector);
                    if (found.length > 0) {
                        log(`Found ${found.length} cards with fallback selector: ${selector}`);
                        // Â¶ÇÊûúÊòØÈìæÊé•ÔºåÊâæÂà∞ÂÖ∂Áà∂ÂÆπÂô®
                        if (selector.includes('a[href')) {
                            cards = Array.from(found).map(a => {
                                // Âêë‰∏äÊâæÂà∞ÂêàÈÄÇÁöÑÂç°ÁâáÂÆπÂô®
                                let parent = a.parentElement;
                                for (let i = 0; i < 5 && parent; i++) {
                                    if (parent.querySelector('img')) {
                                        return parent;
                                    }
                                    parent = parent.parentElement;
                                }
                                return a.parentElement;
                            });
                            // ÂéªÈáç
                            cards = [...new Set(cards)];
                        } else {
                            cards = found;
                        }
                        break;
                    }
                } catch (e) {
                    // Êüê‰∫õÈÄâÊã©Âô®ÂèØËÉΩÊó†Êïà
                }
            }
        }

        log(`Found ${cards.length} product cards`);

        // Ë∞ÉËØïÔºöÊòæÁ§∫ÊâæÂà∞ÁöÑÁ¨¨‰∏Ä‰∏™Âç°ÁâáÁöÑÁ±ªÂêç
        if (cards.length > 0) {
            const firstCard = cards[0];
            log('First card classes:', firstCard.className);
            log('First card tag:', firstCard.tagName);
        } else {
            log('üí° No product cards found. Check your theme\'s HTML structure.');
            log('üí° Look for elements containing product links like: a[href*="/products/"]');
        }

        return Array.from(cards);
    }

    function getCardImages(card) {
        // Â∞ùËØïÂ§öÁßçÈÄâÊã©Âô®ÊâæÂà∞ÂõæÁâáÔºàDawn ‰∏ªÈ¢ò‰ºòÂÖàÔºâ
        const imgSelectors = [
            '.card__media .media img',     // Dawn ‰∏ªÈ¢ò
            '.card__media img',            // Dawn ‰∏ªÈ¢òÂ§áÈÄâ
            '.media--hover-effect img',    // Dawn hover ÊïàÊûúÂõæÁâá
            '.product-card__image img',
            '.product-card-wrapper img',
            '.media img',
            'img[srcset]',
            'img',
        ];

        for (const selector of imgSelectors) {
            const imgs = card.querySelectorAll(selector);
            if (imgs.length > 0) {
                log(`Found ${imgs.length} images with selector: ${selector}`);
                return Array.from(imgs);
            }
        }
        return [];
    }

    function addLoadingOverlay(element) {
        const parent = element.parentElement;
        if (!parent || parent.querySelector('.ai-loading-overlay')) return null;

        const pos = getComputedStyle(parent).position;
        if (pos === 'static') parent.style.position = 'relative';

        const overlay = document.createElement('div');
        overlay.className = 'ai-loading-overlay';
        parent.appendChild(overlay);
        return overlay;
    }

    function createSecondaryImageSlot(card, primaryImg) {
        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÁ¨¨‰∫åÂº†ÂõæÊàñÊàë‰ª¨ÂàõÂª∫ÁöÑ wrapper
        const existingWrapper = card.querySelector('.ai-secondary-image-wrapper');
        if (existingWrapper) return existingWrapper.querySelector('img');

        const imgs = getCardImages(card);
        if (imgs.length >= 2) {
            // Â∑≤ÊúâÁ¨¨‰∫åÂº†ÂõæÔºåÁõ¥Êé•‰ΩøÁî®
            return imgs[1];
        }

        // ÂàõÂª∫Á¨¨‰∫åÂº†ÂõæÁöÑÂÆπÂô®
        const imgContainer = primaryImg.closest('.card__media, .product-card__image, .media') || primaryImg.parentElement;
        if (!imgContainer) return null;

        const pos = getComputedStyle(imgContainer).position;
        if (pos === 'static') imgContainer.style.position = 'relative';

        const wrapper = document.createElement('div');
        wrapper.className = 'ai-secondary-image-wrapper';

        const newImg = document.createElement('img');
        newImg.className = 'ai-generated-image';
        newImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
        newImg.alt = 'AI Generated';

        wrapper.appendChild(newImg);
        imgContainer.appendChild(wrapper);

        return newImg;
    }

    async function processProductCard(card, index) {
        // Ë∑≥ËøáË¢´‰∏™ÊÄßÂåñÂºïÊìéÈöêËóèÁöÑÂç°ÁâáÔºàËäÇÁúÅ API Ë∞ÉÁî®Ôºâ
        if (card.classList.contains('ai-lp-hidden')) {
            log('Skipping hidden card (personalization):', index);
            return;
        }

        const productHandle = getProductHandleFromCard(card);
        if (!productHandle) {
            log('No product handle found for card', index);
            return;
        }

        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â§ÑÁêÜ
        if (generationState.has(productHandle)) {
            log('Already processing/processed:', productHandle);
            return;
        }

        const imgs = getCardImages(card);
        if (imgs.length === 0) {
            log('No images found in card:', productHandle);
            return;
        }

        const primaryImg = imgs[0];
        const originalSrc = primaryImg.src || primaryImg.dataset.src || primaryImg.currentSrc;

        if (!originalSrc || !originalSrc.startsWith('http')) {
            log('Invalid image src:', originalSrc);
            return;
        }

        // Ëé∑ÂèñÊàñÂàõÂª∫Á¨¨‰∫åÂº†ÂõæÁöÑ‰ΩçÁΩÆ
        const secondaryImg = createSecondaryImageSlot(card, primaryImg);
        if (!secondaryImg) {
            log('Could not create secondary image slot');
            return;
        }

        // ËÆæÁΩÆÁä∂ÊÄÅ
        generationState.set(productHandle, {
            status: 'loading',
            imageUrl: null,
            targetImg: secondaryImg,
            card: card,
        });

        // Ê∑ªÂä† loading Áä∂ÊÄÅÂà∞Á¨¨‰∫åÂº†Âõæ
        const overlay = addLoadingOverlay(secondaryImg);

        // Ê£ÄÊü• sessionStorage ÁºìÂ≠òÔºàÂåÖÂê´ UTM ‰ø°ÊÅØÔºâ
        const cacheKey = getUtmCacheKey(productHandle);
        const cachedUrl = getCachedUrl(cacheKey);
        if (cachedUrl) {
            log(`Using cached image for: ${cacheKey}`);
            if (overlay) overlay.remove();  // Á´ãÂç≥ÁßªÈô§ loading
            applyImageToTarget(cachedUrl, secondaryImg, null, productHandle, true);  // skipAnimation = true
            generationState.set(productHandle, { status: 'done', imageUrl: cachedUrl });
            return;
        }

        log(`Starting generation for: ${productHandle} (cache key: ${cacheKey})`);

        try {
            // ‰ΩøÁî®Á¨¨‰∏ÄÂº†ÂõæÔºàÊ∏ÖÊô∞Ë£∏ÂõæÔºâ‰Ωú‰∏∫Á¥†Êùê
            const newUrl = await generateImage(originalSrc, 'product', productHandle);

            if (newUrl) {
                // ‰øùÂ≠òÂà∞ÂÜÖÂ≠òÂíå sessionStorageÔºà‰ΩøÁî®ÂåÖÂê´ UTM ÁöÑ keyÔºâ
                generationState.set(productHandle, {
                    status: 'done',
                    imageUrl: newUrl,
                    targetImg: secondaryImg,
                });
                setSessionCache(cacheKey, newUrl);

                applyImageToTarget(newUrl, secondaryImg, overlay, productHandle);
            } else {
                if (overlay) overlay.remove();
                generationState.set(productHandle, { status: 'error' });
            }
        } catch (error) {
            if (overlay) overlay.remove();
            generationState.set(productHandle, { status: 'error' });
            log('Error:', error);
        }
    }

    function applyImageToTarget(newUrl, targetImg, overlay, logName, skipAnimation = false) {
        log(`Attempting to apply image to ${logName}...`);
        log(`Target img element:`, targetImg);
        log(`New URL:`, newUrl);

        if (!targetImg) {
            log(`‚ùå Target image element is null/undefined for ${logName}`);
            if (overlay) overlay.remove();
            return;
        }

        const preload = new Image();
        preload.crossOrigin = 'anonymous';  // Â∞ùËØïÂ§ÑÁêÜ CORS

        preload.onload = () => {
            log(`‚úÖ Image preloaded successfully for ${logName}`);
            if (overlay) overlay.remove();

            // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑ srcset
            targetImg.removeAttribute('srcset');
            targetImg.removeAttribute('data-srcset');

            // Ê∏ÖÈô§ picture source
            const picture = targetImg.closest('picture');
            if (picture) {
                picture.querySelectorAll('source').forEach(s => s.remove());
                log(`Removed picture sources`);
            }

            // ËÆæÁΩÆÊñ∞ÂõæÁâá
            const oldSrc = targetImg.src;
            targetImg.src = newUrl;
            log(`Image src changed: ${oldSrc?.slice(0, 40)}... ‚Üí ${newUrl.slice(0, 40)}...`);

            // ÁºìÂ≠òÂëΩ‰∏≠Êó∂‰∏çÊòæÁ§∫Âä®Áîª
            if (!skipAnimation) {
                targetImg.classList.add('ai-reveal');
            }

            // ÊòæÁ§∫ wrapperÔºàÂ¶ÇÊûúÊòØÊàë‰ª¨ÂàõÂª∫ÁöÑÔºâ
            const wrapper = targetImg.closest('.ai-secondary-image-wrapper');
            if (wrapper) {
                wrapper.style.opacity = '0'; // hover Êó∂ÊâçÊòæÁ§∫
                log(`Set wrapper opacity to 0 (hover to show)`);
            }

            log(`‚úÖ Applied image for ${logName}`);
        };

        preload.onerror = (e) => {
            if (overlay) overlay.remove();
            log(`‚ùå Failed to load generated image for ${logName}`);
            log(`Error event:`, e);
            log(`Attempted URL:`, newUrl);

            // Â∞ùËØïÁõ¥Êé•ËÆæÁΩÆÔºà‰∏çÈ¢ÑÂä†ËΩΩÔºâ
            log(`Attempting direct src set without preload...`);
            targetImg.src = newUrl;
        };

        preload.src = newUrl;
    }

    async function processAllProductCards() {
        const cards = findProductCards();
        if (cards.length === 0) {
            log('No product cards found on page');
            return;
        }

        log(`Processing ${cards.length} product cards...`);

        // Âπ∂Ë°åÂ§ÑÁêÜÔºå‰ΩÜÈôêÂà∂Âπ∂ÂèëÊï∞
        const chunks = [];
        for (let i = 0; i < cards.length; i += CONFIG.maxConcurrent) {
            chunks.push(cards.slice(i, i + CONFIG.maxConcurrent));
        }

        for (const chunk of chunks) {
            await Promise.all(chunk.map((card, i) => processProductCard(card, i)));
        }

        log('All product cards processed');
    }

    // =====================
    // Banner/Hero Image Â§ÑÁêÜ
    // =====================

    async function processBannerImages() {
        const banners = document.querySelectorAll(CONFIG.bannerSelector);
        if (banners.length === 0) {
            log('No banner images found');
            return;
        }

        log(`Found ${banners.length} banner images`);

        // Banner ÈÄöÂ∏∏Âè™Êúâ 1-2 ‰∏™ÔºåÂÖ®ÈÉ®Âπ∂Ë°åÂ§ÑÁêÜ
        await Promise.all(Array.from(banners).map((img, index) => processBannerImage(img, index)));
    }

    async function processBannerImage(img, index) {
        if (img.dataset.aiProcessed) return;
        img.dataset.aiProcessed = 'true';

        const originalSrc = img.src || img.dataset.src || img.currentSrc;
        if (!originalSrc?.startsWith('http')) return;

        // ÁºìÂ≠ò Key ÂåÖÂê´ UTM ‰ø°ÊÅØ
        const baseCacheKey = `banner_${index}_${originalSrc.slice(-50)}`;
        const cacheKey = getUtmCacheKey(baseCacheKey);

        // Ê£ÄÊü•ÁºìÂ≠ò
        const cachedUrl = getCachedUrl(cacheKey);
        if (cachedUrl) {
            log(`Using cached banner image ${index} (${cacheKey})`);
            applyBannerImage(img, cachedUrl, true);  // skipAnimation = true
            return;
        }

        const overlay = addLoadingOverlay(img);
        log(`Processing banner ${index} (cache key: ${cacheKey})...`);

        try {
            const newUrl = await generateImage(originalSrc, 'banner', `banner_${index}`);

            if (newUrl) {
                setSessionCache(cacheKey, newUrl);  // ‰ΩøÁî®ÂåÖÂê´ UTM ÁöÑ key
                if (overlay) overlay.remove();
                applyBannerImage(img, newUrl);
                log(`‚úÖ Banner ${index} updated`);
            } else {
                if (overlay) overlay.remove();
            }
        } catch (error) {
            if (overlay) overlay.remove();
            log('Banner error:', error);
        }
    }

    function applyBannerImage(img, newUrl, skipAnimation = false) {
        log(`Applying banner image...`);

        const preload = new Image();
        preload.crossOrigin = 'anonymous';

        preload.onload = () => {
            log(`‚úÖ Banner image preloaded`);
            img.removeAttribute('srcset');
            img.removeAttribute('data-srcset');

            const picture = img.closest('picture');
            if (picture) {
                picture.querySelectorAll('source').forEach(s => s.remove());
            }

            if (!skipAnimation) {
                img.classList.add('ai-reveal');
            }
            img.src = newUrl;
            log(`‚úÖ Banner image applied`);
        };

        preload.onerror = (e) => {
            log(`‚ùå Banner image preload failed, trying direct set...`);
            img.src = newUrl;
        };

        preload.src = newUrl;
    }

    // =====================
    // Collection Image Â§ÑÁêÜ
    // =====================

    async function processCollectionImages() {
        const collectionImgs = document.querySelectorAll(CONFIG.collectionImageSelector);
        if (collectionImgs.length === 0) {
            log('No collection images found');
            return;
        }

        log(`Found ${collectionImgs.length} collection images`);

        // Ëé∑Âèñ Collection ‰ø°ÊÅØ
        const collectionInfo = getCollectionInfo();

        await Promise.all(Array.from(collectionImgs).map((img, index) =>
            processCollectionImage(img, index, collectionInfo)
        ));
    }

    async function processCollectionImage(img, index, collectionInfo) {
        if (img.dataset.aiProcessed) return;
        img.dataset.aiProcessed = 'true';

        const originalSrc = img.src || img.dataset.src || img.currentSrc;
        if (!originalSrc?.startsWith('http')) return;

        const baseCacheKey = `collection_${collectionInfo.handle || index}_${originalSrc.slice(-30)}`;
        const cacheKey = getUtmCacheKey(baseCacheKey);

        // Ê£ÄÊü•ÁºìÂ≠ò
        const cachedUrl = getCachedUrl(cacheKey);
        if (cachedUrl) {
            log(`Using cached collection image ${index}`);
            applyGenericImage(img, cachedUrl, true);
            return;
        }

        const overlay = addLoadingOverlay(img);
        log(`Processing collection ${index} with info:`, collectionInfo);

        try {
            // ‰º†ÈÄí collection ‰ø°ÊÅØÁªô API
            const newUrl = await generateImageWithContext(originalSrc, 'collection', {
                collectionTitle: collectionInfo.title,
                collectionDescription: collectionInfo.description,
                productNames: collectionInfo.productNames,
                productCount: collectionInfo.productCount,
            });

            if (newUrl) {
                setSessionCache(cacheKey, newUrl);
                if (overlay) overlay.remove();
                applyGenericImage(img, newUrl);
                log(`‚úÖ Collection ${index} updated`);
            } else {
                if (overlay) overlay.remove();
            }
        } catch (error) {
            if (overlay) overlay.remove();
            log('Collection error:', error);
        }
    }

    // =====================
    // Image with Text Â§ÑÁêÜ
    // =====================

    async function processImageWithTextImages() {
        const images = document.querySelectorAll(CONFIG.imageWithTextSelector);
        if (images.length === 0) {
            log('No image-with-text images found');
            return;
        }

        log(`Found ${images.length} image-with-text images`);
        await Promise.all(Array.from(images).map((img, index) => processGenericImage(img, 'imageWithText', index)));
    }

    // =====================
    // ÈÄöÁî®ÂõæÁâáÂ§ÑÁêÜÔºàCollection, Image with Text Á≠âÔºâ
    // =====================

    async function processGenericImage(img, type, index) {
        if (img.dataset.aiProcessed) return;
        img.dataset.aiProcessed = 'true';

        const originalSrc = img.src || img.dataset.src || img.currentSrc;
        if (!originalSrc?.startsWith('http')) return;

        const baseCacheKey = `${type}_${index}_${originalSrc.slice(-50)}`;
        const cacheKey = getUtmCacheKey(baseCacheKey);

        // Ê£ÄÊü•ÁºìÂ≠ò
        const cachedUrl = getCachedUrl(cacheKey);
        if (cachedUrl) {
            log(`Using cached ${type} image ${index}`);
            applyGenericImage(img, cachedUrl, true);
            return;
        }

        const overlay = addLoadingOverlay(img);
        log(`Processing ${type} ${index} (cache key: ${cacheKey})...`);

        try {
            const newUrl = await generateImage(originalSrc, 'banner', `${type}_${index}`);

            if (newUrl) {
                setSessionCache(cacheKey, newUrl);
                if (overlay) overlay.remove();
                applyGenericImage(img, newUrl);
                log(`‚úÖ ${type} ${index} updated`);
            } else {
                if (overlay) overlay.remove();
            }
        } catch (error) {
            if (overlay) overlay.remove();
            log(`${type} error:`, error);
        }
    }

    function applyGenericImage(img, newUrl, skipAnimation = false) {
        const preload = new Image();
        preload.crossOrigin = 'anonymous';

        preload.onload = () => {
            img.removeAttribute('srcset');
            img.removeAttribute('data-srcset');

            const picture = img.closest('picture');
            if (picture) {
                picture.querySelectorAll('source').forEach(s => s.remove());
            }

            if (!skipAnimation) {
                img.classList.add('ai-reveal');
            }
            img.src = newUrl;
        };

        preload.onerror = () => {
            img.src = newUrl;
        };

        preload.src = newUrl;
    }

    // =====================
    // ‰∫ßÂìÅËØ¶ÊÉÖÈ°µÂ§ÑÁêÜ
    // =====================

    function findProductDetailImages() {
        // Â∞ùËØïÂ§öÁßçÂÆπÂô®ÈÄâÊã©Âô®ÔºàDawn ‰∏ªÈ¢ò‰ºòÂÖàÔºâ
        const containerSelectors = [
            '.product__media-list',           // Dawn ‰∏ªÈ¢ò
            '.product__media-wrapper',        // Dawn ‰∏ªÈ¢ò
            'media-gallery',                  // Dawn custom element
            'slider-component',               // Dawn slider
            '.product__media-gallery',
            '.product-gallery',
            '.product__images',
            '.product-images',
            '[data-product-media-container]',
            '.product-single__media-wrapper',
            CONFIG.productMediaContainerSelector,
        ];

        let container = null;
        for (const selector of containerSelectors) {
            container = document.querySelector(selector);
            if (container) {
                log('Found product media container:', selector);
                break;
            }
        }

        if (!container) {
            // ÊúÄÂêéÂ∞ùËØïÔºöÊâæÂåÖÂê´Â§ö‰∏™‰∫ßÂìÅÂõæÁâáÁöÑÂÆπÂô®
            const allProductImgs = document.querySelectorAll('[class*="product"] img, [data-product] img');
            log('Fallback: found', allProductImgs.length, 'product images');
            if (allProductImgs.length >= 2) {
                return {
                    primary: allProductImgs[0],
                    secondary: allProductImgs[1],
                };
            }
            log('No product media container found');
            return { primary: null, secondary: null };
        }

        // Â∞ùËØïÂ§öÁßçÂ™í‰ΩìÈ°πÈÄâÊã©Âô®
        const mediaItemSelectors = [
            CONFIG.productMediaItemSelector,
            '.product__media-item',
            '.product-media-item',
            '.media-gallery__item',
            'li[data-media-id]',
            '.product__media > *',
        ];

        let mediaItems = [];
        for (const selector of mediaItemSelectors) {
            mediaItems = container.querySelectorAll(selector);
            if (mediaItems.length >= 2) {
                log('Found media items with:', selector, 'count:', mediaItems.length);
                break;
            }
        }

        if (mediaItems.length < 2) {
            // Áõ¥Êé•ÊâæÂõæÁâá
            const allImgs = container.querySelectorAll('img');
            log('Direct image search in container, found:', allImgs.length);
            return {
                primary: allImgs[0] || null,
                secondary: allImgs[1] || null,
            };
        }

        const primaryImg = mediaItems[0]?.querySelector('img');
        const secondaryImg = mediaItems[1]?.querySelector('img');

        log('Primary img:', primaryImg?.src?.slice(0, 50));
        log('Secondary img:', secondaryImg?.src?.slice(0, 50));

        return { primary: primaryImg, secondary: secondaryImg };
    }

    async function processProductDetailPage() {
        log('Processing product detail page...');

        const productHandle = getProductHandleFromUrl();
        if (!productHandle) {
            log('‚ùå Could not extract product handle from URL');
            return;
        }
        log('Product handle:', productHandle);

        // ÂÖàÊ£ÄÊü•ÂÜÖÂ≠òÁºìÂ≠ò
        const existing = generationState.get(productHandle);
        if (existing?.status === 'done' && existing.imageUrl) {
            log('Using memory cached result for:', productHandle);
            applyToDetailPage(existing.imageUrl);
            return;
        }

        // ÂÜçÊ£ÄÊü• sessionStorage ÁºìÂ≠òÔºàË∑®È°µÈù¢ÊåÅ‰πÖÂåñÔºåÂåÖÂê´ UTMÔºâ
        const cacheKey = getUtmCacheKey(productHandle);
        const cachedUrl = getCachedUrl(cacheKey);
        if (cachedUrl) {
            log('Using session cached result for:', cacheKey);
            applyToDetailPage(cachedUrl, true);  // skipAnimation = true
            return;
        }

        log('No cache found, searching for product images...');
        const { primary, secondary } = findProductDetailImages();

        if (!primary) {
            log('‚ùå No primary image found on detail page');
            log('üí° Check if productMediaContainerSelector matches your theme');
            return;
        }

        if (!secondary) {
            log('‚ùå No secondary image found on detail page');
            log('üí° This product may only have 1 image - need at least 2');
            return;
        }

        log('‚úÖ Found primary and secondary images');

        const originalSrc = primary.src || primary.dataset.src || primary.currentSrc;
        if (!originalSrc?.startsWith('http')) return;

        // Ê∑ªÂä† loading
        const overlay = addLoadingOverlay(secondary);

        log(`Processing detail page: ${productHandle}`);

        try {
            const newUrl = await generateImage(originalSrc, 'product', productHandle);

            if (newUrl) {
                // ‰øùÂ≠òÂà∞ÂÜÖÂ≠òÂíå sessionStorageÔºà‰ΩøÁî®ÂåÖÂê´ UTM ÁöÑ keyÔºâ
                generationState.set(productHandle, { status: 'done', imageUrl: newUrl });
                setSessionCache(cacheKey, newUrl);

                log(`Applying to detail page secondary image...`);
                const preload = new Image();
                preload.crossOrigin = 'anonymous';

                preload.onload = () => {
                    log(`‚úÖ Detail page image preloaded`);
                    if (overlay) overlay.remove();

                    // Ê∏ÖÈô§ srcset ÈÅøÂÖçË¶ÜÁõñ
                    secondary.removeAttribute('srcset');
                    secondary.removeAttribute('data-srcset');

                    const picture = secondary.closest('picture');
                    if (picture) {
                        picture.querySelectorAll('source').forEach(s => s.remove());
                    }

                    secondary.classList.add('ai-reveal');
                    secondary.src = newUrl;

                    log(`‚úÖ Detail page updated for ${productHandle}`);
                };

                preload.onerror = (e) => {
                    log(`‚ùå Detail page image preload failed, trying direct set...`);
                    if (overlay) overlay.remove();
                    secondary.src = newUrl;
                };

                preload.src = newUrl;
            } else {
                if (overlay) overlay.remove();
            }
        } catch (error) {
            if (overlay) overlay.remove();
            log('Error on detail page:', error);
        }
    }

    function applyToDetailPage(imageUrl, skipAnimation = false) {
        const { secondary } = findProductDetailImages();
        if (!secondary) {
            log('Cannot apply to detail page: secondary image not found');
            return;
        }

        secondary.removeAttribute('srcset');
        secondary.removeAttribute('data-srcset');

        const picture = secondary.closest('picture');
        if (picture) {
            picture.querySelectorAll('source').forEach(s => s.remove());
        }

        if (!skipAnimation) {
            secondary.classList.add('ai-reveal');
        }
        secondary.src = imageUrl;
        log('Applied AI image to detail page (skipAnimation:', skipAnimation, ')');
    }

    // =====================
    // Landing Page ‰∏™ÊÄßÂåñÂºïÊìé (Theme-Based LLM)
    // =====================

    const LP_CACHE_KEY = 'ai_lp_layout_state';
    const LP_CACHE_TTL = 30 * 60 * 1000;
    const LP_PERSONALIZATION_KEY = 'ai_lp_personalization';

    // --- Lucide SVG Icons (inline, zero deps) ---

    var LUCIDE_ICONS = {
        'paw-print': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="4" r="2"/><circle cx="18" cy="8" r="2"/><circle cx="20" cy="16" r="2"/><circle cx="4" cy="8" r="2"/><circle cx="2" cy="16" r="2"/><path d="M7 18a4 4 0 0 0 4-4 4 4 0 0 0 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4Z"/></svg>',
        'heart': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>',
        'star': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
        'sparkles': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>',
        'shield-check': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>',
        'truck': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/><path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/><circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/></svg>',
        'leaf': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.9C15.5 4.9 17 3.5 19 2c1 2 2 4.5 2 8 0 5.5-4.8 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>',
        'award': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>',
        'check-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>',
        'gift': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M12 8v13"/><path d="M19 12v7a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-7"/><path d="M7.5 8a2.5 2.5 0 0 1 0-5A4.8 8 0 0 1 12 8a4.8 8 0 0 1 4.5-5 2.5 2.5 0 0 1 0 5"/></svg>',
        'smile': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>',
        'sun': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>',
        'zap': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
        'home': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
        'package': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>',
    };

    function getIcon(name) {
        return LUCIDE_ICONS[name] || LUCIDE_ICONS['paw-print'];
    }

    // --- 10 Theme definitions ---
    // Each theme: { sectionOrder, grid2col, flipIWT, hoverZoom, rounded, heroCompact, parallax, iwtOverlap, spacing, featuredHero, stickyVibe, dividers }

    var THEMES = {
        1:  { name: 'Bold Showcase',   sectionOrder: ['products','iwt','collections'], grid2col: true,  flipIWT: true,  hoverZoom: true,  rounded: false, heroCompact: false, parallax: false, iwtOverlap: false, spacing: false, featuredHero: false, stickyVibe: true,  dividers: false },
        2:  { name: 'Story First',     sectionOrder: ['iwt','products','collections'], grid2col: false, flipIWT: true,  hoverZoom: false, rounded: false, heroCompact: false, parallax: false, iwtOverlap: true,  spacing: false, featuredHero: false, stickyVibe: false, dividers: true  },
        3:  { name: 'Quick Shop',      sectionOrder: ['products','collections','iwt'], grid2col: true,  flipIWT: false, hoverZoom: true,  rounded: false, heroCompact: true,  parallax: false, iwtOverlap: false, spacing: false, featuredHero: false, stickyVibe: true,  dividers: false },
        4:  { name: 'Gallery',         sectionOrder: ['products','iwt','collections'], grid2col: true,  flipIWT: false, hoverZoom: false, rounded: true,  heroCompact: false, parallax: true,  iwtOverlap: false, spacing: false, featuredHero: false, stickyVibe: false, dividers: false },
        5:  { name: 'Discovery',       sectionOrder: ['iwt','collections','products'], grid2col: false, flipIWT: true,  hoverZoom: false, rounded: false, heroCompact: false, parallax: true,  iwtOverlap: false, spacing: false, featuredHero: false, stickyVibe: false, dividers: true  },
        6:  { name: 'Premium',         sectionOrder: ['products','iwt','collections'], grid2col: true,  flipIWT: false, hoverZoom: true,  rounded: false, heroCompact: false, parallax: true,  iwtOverlap: true,  spacing: true,  featuredHero: false, stickyVibe: false, dividers: false },
        7:  { name: 'Energetic',       sectionOrder: ['products','iwt','collections'], grid2col: false, flipIWT: true,  hoverZoom: false, rounded: false, heroCompact: true,  parallax: false, iwtOverlap: false, spacing: false, featuredHero: true,  stickyVibe: true,  dividers: false },
        8:  { name: 'Cozy Browse',     sectionOrder: ['iwt','products','collections'], grid2col: false, flipIWT: false, hoverZoom: false, rounded: true,  heroCompact: false, parallax: false, iwtOverlap: false, spacing: true,  featuredHero: false, stickyVibe: false, dividers: true  },
        9:  { name: 'Impact',          sectionOrder: ['products','collections','iwt'], grid2col: true,  flipIWT: true,  hoverZoom: true,  rounded: false, heroCompact: true,  parallax: false, iwtOverlap: true,  spacing: false, featuredHero: true,  stickyVibe: false, dividers: false },
        10: { name: 'Clean Default',   sectionOrder: ['products','iwt','collections'], grid2col: false, flipIWT: false, hoverZoom: true,  rounded: false, heroCompact: false, parallax: false, iwtOverlap: false, spacing: false, featuredHero: false, stickyVibe: false, dividers: false },
    };

    // --- LLM ‰∏™ÊÄßÂåñÈ¢ÑÂä†ËΩΩ ---

    let _personalizationPromise = null;
    let _personalizationCache = null;

    function preloadPersonalization() {
        var utm = getUtmParams();
        if (!utm.utmSource && !utm.utmCampaign && !utm.utmContent) {
            return Promise.resolve(null);
        }

        var fingerprint = getUtmFingerprint();
        try {
            var stored = sessionStorage.getItem(LP_PERSONALIZATION_KEY);
            if (stored) {
                var parsed = JSON.parse(stored);
                if (parsed.fingerprint === fingerprint && Date.now() - parsed.timestamp < LP_CACHE_TTL) {
                    _personalizationCache = parsed.config;
                    log('[AI-LP] Personalization loaded from session cache');
                    return Promise.resolve(parsed.config);
                }
            }
        } catch (e) { /* ignore */ }

        // Á≠â productMeta ÂáÜÂ§áÂ•ΩÂÜçÂèëËØ∑Ê±ÇÔºàÈúÄË¶ÅÊää‰∫ßÂìÅÂàóË°®ÂèëÁªô LLMÔºâ
        _personalizationPromise = (async function () {
            var _llmFetchStart = Date.now();
            log('[AI-LP] ‚è±Ô∏è Personalization: waiting for product meta...');

            var meta = _productMetaCache;
            if (!meta) {
                meta = await Promise.race([
                    _productMetaPromise || Promise.resolve({}),
                    new Promise(function (resolve) { setTimeout(function () { resolve({}); }, 1500); }),
                ]);
            }

            var products = [];
            if (meta && typeof meta === 'object') {
                Object.keys(meta).forEach(function (handle) {
                    var p = meta[handle];
                    products.push({ handle: p.handle, title: p.title, tags: p.tags || [] });
                });
            }

            log('[AI-LP] ‚è±Ô∏è Personalization fetch started at', new Date().toISOString(), 'with', products.length, 'products');

            try {
                var res = await fetch(CONFIG.apiUrl + '/personalize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        utmSource: utm.utmSource,
                        utmMedium: utm.utmMedium,
                        utmCampaign: utm.utmCampaign,
                        utmContent: utm.utmContent,
                        utmTerm: utm.utmTerm,
                        products: products,
                    }),
                });

                var elapsed1 = Date.now() - _llmFetchStart;
                log('[AI-LP] ‚è±Ô∏è Personalization fetch response:', res.status, 'in', elapsed1 + 'ms');

                if (!res.ok) return null;
                var data = await res.json();
                var elapsed2 = Date.now() - _llmFetchStart;

                if (data && data.success && data.config) {
                    _personalizationCache = data.config;
                    try {
                        sessionStorage.setItem(LP_PERSONALIZATION_KEY, JSON.stringify({
                            fingerprint: fingerprint,
                            config: data.config,
                            timestamp: Date.now(),
                        }));
                    } catch (e) { /* ignore */ }
                    log('[AI-LP] ‚è±Ô∏è LLM personalization loaded in', elapsed2 + 'ms', data.cached ? '(server-cached)' : '(fresh)', 'serverTime:', data.processingTime + 'ms');
                    log('[AI-LP] Config:', JSON.stringify(data.config, null, 2));
                    return data.config;
                }
                return null;
            } catch (err) {
                log('[AI-LP] ‚è±Ô∏è Personalization fetch FAILED in', (Date.now() - _llmFetchStart) + 'ms:', err && err.message ? err.message : err);
                return null;
            }
        })();

        return _personalizationPromise;
    }

    preloadPersonalization();

    // --- ‰∫ßÂìÅËøáÊª§ÔºàÂÖ≥ÈîÆËØçÈ©±Âä®ÔºåÁû¨Êó∂Ôºå‰∏çÁ≠â LLMÔºâ ---

    function extractContentIntent(campaign, content) {
        var raw = [campaign, content].filter(Boolean).join('-').toLowerCase();
        if (!raw) return [];
        var tokens = raw.split(/[-_\s.]+/).filter(function (t) { return t.length > 2; });
        var stopWords = ['utm','source','medium','campaign','content','term','ad','ads','video','image','carousel','story','reel','post','static','dynamic','feed','explore','reels','v1','v2','v3','test','draft','final','the','for','and','with','from','new','best','top','spring','summer','fall','autumn','winter','jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec','lovers','fans','owners','parents','people','retarget','retargeting','lookalike','broad','interest','sale','promo','discount','offer','deal'];
        var stopSet = {};
        stopWords.forEach(function (w) { stopSet[w] = true; });
        return tokens.filter(function (t) { return !stopSet[t] && !/^\d+$/.test(t); });
    }

    var FILTER_RULES = [
        { keywords: ['dog','puppy','canine','pup'], relevantTags: ['dog'], relevantKeywords: ['dog','puppy','pup'] },
        { keywords: ['cat','kitten','feline','kitty'], relevantTags: ['cat'], relevantKeywords: ['cat','kitten','kitty','mouse','mousey','birdy','fish'] },
    ];

    function getFilterAction(contentIntent) {
        for (var i = 0; i < FILTER_RULES.length; i++) {
            var rule = FILTER_RULES[i];
            if (rule.keywords.some(function (kw) { return contentIntent.indexOf(kw) !== -1; }))
                return { relevantTags: rule.relevantTags, relevantKeywords: rule.relevantKeywords };
        }
        return { relevantTags: null, relevantKeywords: null };
    }

    function isProductRelevant(handle, meta, action) {
        if (!action.relevantTags || action.relevantTags.length === 0) return true;
        if (meta && meta.tags && meta.tags.length > 0) {
            if (action.relevantTags.some(function (rt) { return meta.tags.indexOf(rt) !== -1; })) return true;
        }
        if (action.relevantKeywords && action.relevantKeywords.length > 0) {
            var s = ((handle || '') + ' ' + (meta && meta.title ? meta.title : '')).toLowerCase();
            if (action.relevantKeywords.some(function (kw) { return s.indexOf(kw) !== -1; })) return true;
        }
        if (!meta || !meta.tags || meta.tags.length === 0) return true;
        return false;
    }

    function filterByRelevance(cards, productMeta, action) {
        if (!action.relevantTags || action.relevantTags.length === 0) return { visibleCards: cards.slice(), hiddenHandles: [] };
        var relevant = [], irrelevant = [];
        cards.forEach(function (card) {
            var handle = getProductHandleFromCard(card);
            var meta = handle ? productMeta[handle] : null;
            (isProductRelevant(handle, meta, action) ? relevant : irrelevant).push({ card: card, handle: handle });
        });
        if (relevant.length < 2) return { visibleCards: cards.slice(), hiddenHandles: [] };
        var hiddenHandles = [];
        irrelevant.forEach(function (item) {
            item.card.classList.add('ai-lp-hidden');
            var unit = getReorderableUnit(item.card);
            if (unit !== item.card) unit.classList.add('ai-lp-hidden');
            if (item.handle) hiddenHandles.push(item.handle);
        });
        relevant.forEach(function (item) {
            item.card.classList.remove('ai-lp-hidden');
            var unit = getReorderableUnit(item.card);
            if (unit !== item.card) unit.classList.remove('ai-lp-hidden');
        });
        log('[AI-LP] Filtered:', relevant.length, 'visible,', irrelevant.length, 'hidden');
        return { visibleCards: relevant.map(function (r) { return r.card; }), hiddenHandles: hiddenHandles };
    }

    // --- ‰∫ßÂìÅÊéíÂ∫èÔºàLLM handle È°∫Â∫èÔºâ ---

    function reorderByHandleList(cards, orderedHandles) {
        if (!orderedHandles || orderedHandles.length === 0) return;
        if (cards.length <= 1) return;
        var container = findCardsContainer(cards);
        if (!container) return;

        var unitMap = new Map();
        cards.forEach(function (card) {
            var handle = getProductHandleFromCard(card);
            if (handle) unitMap.set(handle, getReorderableUnit(card));
        });

        var placed = {};
        orderedHandles.forEach(function (handle) {
            var unit = unitMap.get(handle);
            if (unit) { container.appendChild(unit); placed[handle] = true; }
        });
        // Append any cards not in the LLM order
        cards.forEach(function (card) {
            var handle = getProductHandleFromCard(card);
            if (handle && !placed[handle]) container.appendChild(getReorderableUnit(card));
        });
        log('[AI-LP] Reordered products by LLM order');
    }

    function findCardsContainer(cards) {
        if (cards.length === 0) return null;
        var units = cards.map(function (c) { return getReorderableUnit(c); });
        var parentCounts = new Map();
        units.forEach(function (unit) {
            var parent = unit.parentElement;
            if (parent) parentCounts.set(parent, (parentCounts.get(parent) || 0) + 1);
        });
        var best = null, bestCount = 0;
        parentCounts.forEach(function (count, parent) { if (count > bestCount) { bestCount = count; best = parent; } });
        return best;
    }

    function getReorderableUnit(card) {
        var current = card;
        for (var i = 0; i < 5 && current.parentElement; i++) {
            var parent = current.parentElement;
            var tag = parent.tagName.toLowerCase();
            if (tag === 'ul' || tag === 'ol' || parent.classList.contains('grid') || parent.classList.contains('product-grid') || parent.classList.contains('collection-product-list') || parent.classList.contains('product-list')) return current;
            current = parent;
        }
        return card.parentElement || card;
    }

    // --- Section Êü•Êâæ‰∏éÈáçÊéíÂ∫è ---

    function findSectionByPattern(patterns) {
        var main = document.querySelector('#MainContent, main, [role="main"]');
        if (!main) return null;
        var sections = main.querySelectorAll('.shopify-section, section');
        for (var i = 0; i < sections.length; i++) {
            var id = (sections[i].id || '').toLowerCase();
            // ‰πüÊ£ÄÊü• section ÂÜÖÈÉ®ÁöÑ class ÂíåÂÜÖÂÆπ
            var inner = sections[i].innerHTML.substring(0, 500).toLowerCase();
            for (var j = 0; j < patterns.length; j++) {
                var p = patterns[j];
                if (id.includes(p)) return sections[i];
                // ÂÖúÂ∫ïÔºöÊ£ÄÊü• section ÂÜÖÈÉ®ÊòØÂê¶ÊúâÂåπÈÖç class ÁöÑÂÖÉÁ¥†
                if (p === 'image_with_text' && (inner.includes('image-with-text') || sections[i].querySelector('.image-with-text'))) return sections[i];
                if (p === 'featured' && (inner.includes('featured') || sections[i].querySelector('[class*="collection"]'))) {
                    // ÊéíÈô§ collection_list
                    if (!id.includes('collection_list')) return sections[i];
                }
            }
        }
        return null;
    }

    function reorderSections(sectionOrder) {
        try {
            var main = document.querySelector('#MainContent, main, [role="main"]');
            if (!main) return;

            var heroSection = findSectionByPattern(['image_banner', 'slideshow', 'hero']);
            var productsSection = findSectionByPattern(['featured']);
            var iwtSection = findSectionByPattern(['image_with_text']);
            var collectionsSection = findSectionByPattern(['collection_list']);

            if (!heroSection) return;

            var sectionMap = { products: productsSection, iwt: iwtSection, collections: collectionsSection };
            var anchor = heroSection;

            // Also account for injected vibe bar between hero and next section
            var vibeBar = document.querySelector('[data-ai-lp-vibe-bar]');
            if (vibeBar) anchor = vibeBar;

            sectionOrder.forEach(function (key) {
                var section = sectionMap[key];
                if (section && section.parentElement) {
                    anchor.parentElement.insertBefore(section, anchor.nextSibling);
                    anchor = section;
                }
            });
            log('[AI-LP] Sections reordered:', sectionOrder.join(' ‚Üí '));
        } catch (err) {
            log('[AI-LP] Section reorder error:', err);
        }
    }

    // --- ËßÜËßâÁªÑ‰ª∂ ---

    function injectVibeBar(config, sticky) {
        try {
            if (document.querySelector('[data-ai-lp-vibe-bar]')) return;
            if (!config || !config.copy || !config.copy.vibeBarText) return;
            var heroSection = findSectionByPattern(['image_banner', 'slideshow', 'hero']);
            if (!heroSection) return;

            var bar = document.createElement('div');
            bar.className = 'ai-lp-vibe-bar' + (sticky ? ' ai-lp-sticky' : '');
            bar.setAttribute('data-ai-lp-vibe-bar', 'true');
            bar.innerHTML = '<span class="ai-lp-vibe-bar__icon">' + getIcon(config.vibeIcon || 'paw-print') + '</span>' +
                            '<span class="ai-lp-vibe-bar__text">' + config.copy.vibeBarText + '</span>';
            heroSection.parentElement.insertBefore(bar, heroSection.nextSibling);
            log('[AI-LP] Vibe Bar injected' + (sticky ? ' (sticky)' : ''));
        } catch (err) { log('[AI-LP] Vibe Bar error:', err); }
    }

    function injectTrustBlock(config) {
        try {
            if (document.querySelector('[data-ai-lp-trust-block]')) return;
            if (!config || !config.copy || !config.copy.trustItems) return;
            var productsSection = findSectionByPattern(['featured', 'collection']);
            if (productsSection && (productsSection.id || '').toLowerCase().includes('collection_list')) productsSection = null;
            if (!productsSection) return;

            var icons = config.trustIcons || ['shield-check', 'truck', 'leaf'];
            var items = config.copy.trustItems;
            var block = document.createElement('div');
            block.className = 'ai-lp-trust-block';
            block.setAttribute('data-ai-lp-trust-block', 'true');
            for (var i = 0; i < 3 && i < items.length; i++) {
                block.innerHTML += '<div class="ai-lp-trust-item"><span class="ai-lp-trust-item__icon">' + getIcon(icons[i]) + '</span><span class="ai-lp-trust-item__text">' + items[i] + '</span></div>';
            }
            productsSection.parentElement.insertBefore(block, productsSection.nextSibling);
            log('[AI-LP] Trust Block injected');
        } catch (err) { log('[AI-LP] Trust Block error:', err); }
    }

    function injectDividers() {
        try {
            var main = document.querySelector('#MainContent, main, [role="main"]');
            if (!main) return;
            var sections = main.querySelectorAll('.shopify-section');
            sections.forEach(function (section) {
                if (section.nextElementSibling && section.nextElementSibling.classList.contains('shopify-section') && !section.nextElementSibling.previousElementSibling.classList.contains('ai-lp-divider')) {
                    var divider = document.createElement('div');
                    divider.className = 'ai-lp-divider';
                    divider.setAttribute('data-ai-lp-divider', 'true');
                    divider.innerHTML = getIcon('sparkles');
                    section.parentElement.insertBefore(divider, section.nextSibling);
                }
            });
            log('[AI-LP] Section dividers injected');
        } catch (err) { log('[AI-LP] Dividers error:', err); }
    }

    // --- ÊñáÊ°àÊõøÊç¢Ôºà‰øùÊåÅÂ≠óÂè∑Ôºâ ---

    function setTextSafe(section, selector, text) {
        if (!section || !text) return;
        var el = section.querySelector(selector);
        if (!el) {
            log('[AI-LP] Text: selector "' + selector + '" NOT FOUND in section', section.id || section.className);
            return;
        }

        // Êü•ÊâæÊúÄÂÜÖÂ±ÇÁöÑÊñáÊú¨ÊâøËΩΩÂÖÉÁ¥†Ôºàh1, h2, h3, p, span Á≠âÔºâÔºåÈÅøÂÖçÊõøÊç¢ wrapper div
        var innerEl = el;
        var headings = el.querySelectorAll('h1, h2, h3, p, span');
        if (headings.length > 0) {
            // ÈÄâÊúÄÊ∑±ÁöÑÈÇ£‰∏™
            innerEl = headings[headings.length - 1];
            for (var i = 0; i < headings.length; i++) {
                if (headings[i].textContent.trim().length > 0) { innerEl = headings[i]; break; }
            }
        }
        if (!innerEl.dataset.aiOriginalText) {
            innerEl.dataset.aiOriginalText = innerEl.textContent;
        }
        innerEl.textContent = text;
        log('[AI-LP] Text: "' + (innerEl.dataset.aiOriginalText || '').slice(0, 20) + '..." ‚Üí "' + text + '"');
    }

    function applyTextFromConfig(config) {
        try {
            if (!config || !config.copy) return;
            var rules = [
                { patterns: ['image_banner','slideshow','hero'], selector: 'h2, h1, .banner__heading, .slideshow__heading', text: config.copy.heroTitle },
                { patterns: ['featured'], selector: '.collection__title, .title-wrapper, h2, .title', text: config.copy.featuredTitle },
                { patterns: ['image_with_text'], selector: 'h2, .image-with-text__heading', text: config.copy.iwtTitle },
                { patterns: ['image_with_text'], selector: '.image-with-text__text p, .rte p, p', text: config.copy.iwtBody },
            ];
            rules.forEach(function (rule) {
                var section = findSectionByPattern(rule.patterns);
                if (!section) {
                    log('[AI-LP] Text: section NOT FOUND for patterns', rule.patterns.join(','));
                    return;
                }
                setTextSafe(section, rule.selector, rule.text);
            });
        } catch (err) { log('[AI-LP] Text error:', err); }
    }

    // --- Parallax hero effect ---

    function initParallax() {
        try {
            var heroImg = document.querySelector('.banner__media img, .slideshow__image, .hero__image img');
            if (!heroImg) return;
            heroImg.style.transition = 'transform 0.1s linear';
            window.addEventListener('scroll', function () {
                var scrollY = window.pageYOffset || window.scrollY;
                if (scrollY < 800) {
                    heroImg.style.transform = 'translateY(' + (scrollY * 0.3) + 'px) scale(1.08)';
                }
            }, { passive: true });
            log('[AI-LP] Parallax initialized');
        } catch (err) { log('[AI-LP] Parallax error:', err); }
    }

    // --- Â∫îÁî® Theme ---

    function applyTheme(themeNum, config, container) {
        var theme = THEMES[themeNum] || THEMES[10];
        log('[AI-LP] Applying theme', themeNum, '(' + theme.name + ')');

        // ÊñáÊ°à
        applyTextFromConfig(config);

        // Vibe BarÔºàÊâÄÊúâ theme ÈÉΩÊúâÔºâ
        injectVibeBar(config, theme.stickyVibe);

        // Trust BlockÔºàÊâÄÊúâ theme ÈÉΩÊúâÔºâ
        injectTrustBlock(config);

        // Section ÈáçÊéíÂ∫è
        reorderSections(theme.sectionOrder);

        // Grid layout
        if (theme.grid2col && container) container.classList.add('ai-lp-grid-2col');

        // IWT flip
        if (theme.flipIWT) {
            var iwt = findSectionByPattern(['image_with_text']);
            if (iwt) iwt.classList.add('ai-lp-iwt-flip');
        }

        // IWT overlap
        if (theme.iwtOverlap) {
            var iwtOv = findSectionByPattern(['image_with_text']);
            if (iwtOv) iwtOv.classList.add('ai-lp-iwt-overlap');
        }

        // Hover zoom
        if (theme.hoverZoom && container) {
            var gridParent = container.closest('.shopify-section') || container.parentElement;
            if (gridParent) gridParent.classList.add('ai-lp-hover-zoom');
        }

        // Rounded cards
        if (theme.rounded && container) {
            var roundParent = container.closest('.shopify-section') || container.parentElement;
            if (roundParent) roundParent.classList.add('ai-lp-rounded');
        }

        // Compact hero
        if (theme.heroCompact) {
            var heroSec = findSectionByPattern(['image_banner', 'slideshow', 'hero']);
            if (heroSec) heroSec.classList.add('ai-lp-hero-compact');
        }

        // Parallax
        if (theme.parallax) {
            var heroPar = findSectionByPattern(['image_banner', 'slideshow', 'hero']);
            if (heroPar) { heroPar.classList.add('ai-lp-parallax'); initParallax(); }
        }

        // Extra spacing
        if (theme.spacing) {
            var mainEl = document.querySelector('#MainContent, main, [role="main"]');
            if (mainEl) mainEl.classList.add('ai-lp-spacing');
        }

        // Featured hero card (first card enlarged)
        if (theme.featuredHero && container) container.classList.add('ai-lp-featured-hero');

        // Section dividers
        if (theme.dividers) injectDividers();

        log('[AI-LP] Theme', themeNum, 'applied successfully');
    }

    // --- Cleanup ---

    function cleanupInjectedElements() {
        try {
            // Remove injected elements
            document.querySelectorAll('[data-ai-lp-vibe-bar],[data-ai-lp-trust-block],[data-ai-lp-divider]').forEach(function (el) { el.remove(); });
            // Restore text
            document.querySelectorAll('[data-ai-original-text]').forEach(function (el) {
                el.textContent = el.dataset.aiOriginalText;
                el.removeAttribute('data-ai-original-text');
            });
            // Remove all theme CSS classes
            var themeClasses = ['ai-lp-iwt-flip','ai-lp-iwt-overlap','ai-lp-grid-2col','ai-lp-hover-zoom','ai-lp-rounded','ai-lp-hero-compact','ai-lp-parallax','ai-lp-spacing','ai-lp-featured-hero'];
            themeClasses.forEach(function (cls) {
                document.querySelectorAll('.' + cls).forEach(function (el) { el.classList.remove(cls); });
            });
        } catch (err) { /* ignore */ }
    }

    // --- Â∏ÉÂ±ÄÁºìÂ≠ò ---

    function getUtmFingerprint() {
        var utm = getUtmParams();
        return [utm.utmSource || '', utm.utmCampaign || '', utm.utmContent || ''].join('|');
    }

    function cacheLayoutDecision(decision) {
        try {
            sessionStorage.setItem(LP_CACHE_KEY, JSON.stringify({
                productOrder: decision.productOrder,
                hiddenProducts: decision.hiddenProducts,
                utmFingerprint: decision.utmFingerprint,
                timestamp: Date.now(),
            }));
        } catch (e) { log('[AI-LP] Cache write failed:', e); }
    }

    function restoreLayoutDecision() {
        try {
            var raw = sessionStorage.getItem(LP_CACHE_KEY);
            if (!raw) return null;
            var state = JSON.parse(raw);
            if (state.utmFingerprint !== getUtmFingerprint()) { sessionStorage.removeItem(LP_CACHE_KEY); return null; }
            if (Date.now() - state.timestamp > LP_CACHE_TTL) { sessionStorage.removeItem(LP_CACHE_KEY); return null; }
            return state;
        } catch (e) { return null; }
    }

    function restoreFromCache(cards, cached) {
        if (cached.productOrder && cached.productOrder.length > 0) {
            var container = findCardsContainer(cards);
            if (container) {
                var unitMap = new Map();
                cards.forEach(function (card) { var h = getProductHandleFromCard(card); if (h) unitMap.set(h, getReorderableUnit(card)); });
                var placed = {};
                cached.productOrder.forEach(function (h) { var u = unitMap.get(h); if (u) { container.appendChild(u); placed[h] = true; } });
                cards.forEach(function (card) { var h = getProductHandleFromCard(card); if (h && !placed[h]) container.appendChild(getReorderableUnit(card)); });
            }
        }
        if (cached.hiddenProducts && cached.hiddenProducts.length > 0) {
            var hiddenSet = {};
            cached.hiddenProducts.forEach(function (h) { hiddenSet[h] = true; });
            cards.forEach(function (card) {
                var h = getProductHandleFromCard(card);
                var unit = getReorderableUnit(card);
                if (h && hiddenSet[h]) { card.classList.add('ai-lp-hidden'); if (unit !== card) unit.classList.add('ai-lp-hidden'); }
                else { card.classList.remove('ai-lp-hidden'); if (unit !== card) unit.classList.remove('ai-lp-hidden'); }
            });
        }
        log('[AI-LP] Restored product layout from cache');
    }

    // --- ‰∏ªÂÖ•Âè£Ôºà‰∏§Èò∂ÊÆµÔºâ ---

    async function applyLandingPersonalization() {
        try {
            var path = window.location.pathname;
            if (path !== '/' && path !== '') return;

            var allCards = findProductCards();
            var cards = allCards.filter(function (card) { return getProductHandleFromCard(card) !== null; });
            if (!cards || cards.length === 0) return;

            var container = findCardsContainer(cards);
            if (!container) { log('[AI-LP] No card container found'); return; }

            if (container.getAttribute('data-ai-lp-applied') === 'true') { log('[AI-LP] Already applied'); return; }
            cleanupInjectedElements();

            var utm = getUtmParams();
            var contentIntent = extractContentIntent(utm.utmCampaign, utm.utmContent);

            // ========== Phase 1: Áû¨Êó∂ËøáÊª§ ==========
            var productMeta = _productMetaCache;
            if (!productMeta) {
                productMeta = await Promise.race([
                    _productMetaPromise || Promise.resolve({}),
                    new Promise(function (resolve) { setTimeout(function () { resolve(null); }, 500); }),
                ]);
                if (!productMeta) productMeta = {};
            }

            var filterAction = getFilterAction(contentIntent);
            var filterResult = filterByRelevance(cards, productMeta, filterAction);
            var visibleCards = filterResult.visibleCards;
            var hiddenHandles = filterResult.hiddenHandles;
            log('[AI-LP] Phase 1 done:', visibleCards.length, 'visible,', hiddenHandles.length, 'hidden');

            var cached = restoreLayoutDecision();
            if (cached) {
                restoreFromCache(cards, cached);
                visibleCards = cards.filter(function (c) { return !c.classList.contains('ai-lp-hidden'); });
            }

            // ========== Phase 2: LLM Theme ==========
            var _phase2Start = Date.now();
            var llmConfig = _personalizationCache;
            if (llmConfig) { log('[AI-LP] ‚è±Ô∏è Phase 2: config in cache (0ms)'); }
            if (!llmConfig) {
                log('[AI-LP] ‚è±Ô∏è Phase 2: Waiting for LLM (max 10s)...');
                llmConfig = await Promise.race([
                    _personalizationPromise || Promise.resolve(null),
                    new Promise(function (resolve) { setTimeout(function () { resolve(null); }, 10000); }),
                ]);
                log('[AI-LP] ‚è±Ô∏è Phase 2: wait done in', (Date.now() - _phase2Start) + 'ms', llmConfig ? '(got config)' : '(timeout)');
            }

            if (llmConfig) {
                // LLM-driven product reorder
                if (llmConfig.productOrder && llmConfig.productOrder.length > 0) {
                    reorderByHandleList(visibleCards, llmConfig.productOrder);
                }
                // Apply theme
                applyTheme(llmConfig.theme || 10, llmConfig, container);
            } else {
                log('[AI-LP] Phase 2: No LLM, applying default theme');
                applyTheme(10, { copy: {}, vibeIcon: 'paw-print', trustIcons: ['shield-check','truck','leaf'] }, container);
            }

            // Cache final state
            var orderedHandles = visibleCards.map(function (c) { return getProductHandleFromCard(c); }).filter(Boolean);
            container.setAttribute('data-ai-lp-applied', 'true');
            cacheLayoutDecision({ productOrder: orderedHandles, hiddenProducts: hiddenHandles, utmFingerprint: getUtmFingerprint() });

            log('[AI-LP] ‚úÖ Done' + (llmConfig ? ' (theme ' + llmConfig.theme + ')' : ' (fallback)'));
        } catch (err) {
            log('[AI-LP] ‚ùå Error:', err);
            if (typeof console !== 'undefined' && console.error) console.error('[AI-LP] Personalization error:', err);
        }
    }

    // =====================
    // ÂÖ•Âè£
    // =====================

    function init() {
        log('AI Visual v2 checking conditions...');
        log('URL:', window.location.href);
        log('Referrer:', document.referrer);
        log('UTM params:', getUtmParams());

        if (!shouldProcess()) {
            log('‚ùå No UTM/referrer detected, skipping AI generation');
            log('üí° Tip: Add ?utm_source=test to URL to test');
            return;
        }

        log('‚úÖ AI Visual v2 initializing...');

        // Show welcome modal on first visit
        setTimeout(() => showWelcomeModal(), CONFIG.welcomeModalDelay);

        const isProductPage = window.location.pathname.includes('/products/');
        const isHomePage = window.location.pathname === '/' || window.location.pathname === '';
        const isCollectionPage = window.location.pathname.includes('/collections/');

        log('Page type:', { isHomePage, isCollectionPage, isProductPage });

        // Êî∂ÈõÜÊâÄÊúâÈúÄË¶ÅÊâßË°åÁöÑ‰ªªÂä°
        const tasks = [];

        // È¶ñÈ°µÊàñÈõÜÂêàÈ°µÔºöÂ§ÑÁêÜ‰∫ßÂìÅÂç°Áâá„ÄÅBanner„ÄÅCollection„ÄÅImage with Text
        if (isHomePage || isCollectionPage || !isProductPage) {
            if (isHomePage) {
                // ‚òÖ È¶ñÈ°µÔºöÂÖàÊâßË°å‰∏™ÊÄßÂåñÔºàËøáÊª§/ÊéíÂ∫èÔºâÔºåÂÜçÁîüÊàêÂõæÁâá
                // ‰∏™ÊÄßÂåñÂÆåÊàêÂêéÊâçÂºÄÂßã processAllProductCardsÔºåÁ°Æ‰øùÈöêËóèÁöÑÂç°Áâá‰∏çÊµ™Ë¥π API
                tasks.push(
                    applyLandingPersonalization().then(() => processAllProductCards())
                );
            } else {
                tasks.push(processAllProductCards());
            }
            tasks.push(processBannerImages());
            tasks.push(processCollectionImages());      // Collection ÂõæÁâá
            tasks.push(processImageWithTextImages());   // Image with Text ÂõæÁâá
        }

        // ‰∫ßÂìÅËØ¶ÊÉÖÈ°µÔºöÂ§ÑÁêÜËØ¶ÊÉÖÂõæ
        if (isProductPage) {
            tasks.push(processProductDetailPage());
        }

        // Âπ∂Ë°åÊâßË°åÊâÄÊúâ‰ªªÂä°
        Promise.all(tasks).then(() => {
            log('All processing complete');
        });
    }

    // Á≠âÂæÖ DOM ÂíåÂõæÁâáÂä†ËΩΩ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setTimeout(init, 300));
    } else {
        setTimeout(init, 300);
    }

    // ÁõëÂê¨ SPA Ë∑ØÁî±ÂèòÂåñÔºàShopify Êúâ‰∫õ‰∏ªÈ¢òÁî® AJAXÔºâ
    let lastUrl = location.href;
    new MutationObserver(() => {
        if (location.href !== lastUrl) {
            lastUrl = location.href;
            log('URL changed, re-initializing...');
            setTimeout(init, 500);
        }
    }).observe(document.body, { subtree: true, childList: true });

})();
</script>
